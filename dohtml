#! /bin/sh

htmldir=/org/bugs.debian.org/www/bugscan

realmakepage() {
	local	filter="$1"	# Distributions to list
	local	title="$2"	# Title of page
	local	date="$3"	# Date
	local	worry="$4"	# Worry about testing only?
	local	descr		# Description of filter

	if [ -z "$filter" ]; then
		descr="all"
	else
		descr="$filter"
		filter="-d $filter"
	fi

	filter="$filter $worry"

	cat <<EOF
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>$title, $date</title>
  </head>
<body bgcolor="white">
<h1 align="center">$title</h1>

<h2 align="center">$date</h2>

<p align="center">for distribution(s): $descr</p>

<hr>

<p>
EOF
	./bugreport -H -s $filter
	
	cat <<EOF
<p>
Explanation for <a href="http://www.debian.org/Bugs/Developer#tags">bug
tags</a>:

<ul>
   <li><strong>P</strong>: pending</li>
   <li><strong>+</strong>: patch</li>
   <li><strong>H</strong>: help</li>
   <li><strong>M</strong>: moreinfo</li>
   <li><strong>R</strong>: unreproducible</li>
   <li><strong>S</strong>: security</li>
   <li><strong>U</strong>: upstream</li>
   <li><strong>I</strong>: wheezy-ignore or jessie-ignore</li>
</ul>

<p>
The second set of tags indicate what releases a bug applies to:
O for oldstable (squeeze), S for stable (wheezy), T for testing (jessie),
U for unstable (sid) or E for experimental.

<p>

EOF
	./bugreport -H -l $filter

	cat <<EOF
<hr>
This page is automatically generated.<br>
Please contact
<a href="mailto:owner@bugs.debian.org">owner@bugs.debian.org</a> for comments.
</body>
</html>
EOF
}

makemainpage() {
	cat <<EOF
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>$title, $time</title>
  </head>
<body bgcolor="white">
<h1 align="center">$title</h1>

<h2 align="center">$time</h2>

<p align="center">
EOF

	./bugreport -Hs

	cat <<EOF
</p>

<div align="center"><img src="graph-release.png" alt="Graph of RC bugs"></div>

<p>Other graphs:
  <ul>
    <li><a href="graph-month.png">Graph for the last month</a></li>
    <li><a href="graph.png">Graph with all the history</a></li>
  </ul>
</p>

<p>The red line graphs all bugs with release-critical severities; the green
line graphs the number of bugs that are actually a concern for the next
release (excluding ignored bugs, bugs on packages not in testing, and bugs
whose tags and/or versioning information indicate that they don't apply to
testing), and the blue line graphs the number of bugs that are a concern
for the <em>current</em> stable release.</p>

<h2>Recent changes</h2>
EOF

	./bugdiff -Hncs status-old status

	cat <<EOF

<h2>Detailed lists of RC bug reports:</h2>

<ul>
  <li> <a href="debian/all.html">All</a>
  <li> <a href="debian/main.html">main</a>
  <li> <a href="debian/source.html">source</a> 
  <li> <a href="debian/contrib.html">contrib</a>
  <li> <a href="debian/non-free.html">non-free</a>
  <li><a href="other/pseudo.html">pseudo-packages</a>
       <a href="http://www.debian.org/Bugs/pseudo-packages">(?)</a>
  <li><a href="other/all.html">Everything in one page</a>
    <br>
     + <a href="other/stable.html">Only bugs relevant to stable</a>
    <br>
     + <a href="other/testing.html">Only bugs relevant to testing</a>
</ul>
<p clear=both>
<hr>
This page is automatically generated.<br>
Please contact
<a href="mailto:owner@bugs.debian.org">owner@bugs.debian.org</a> for comments.
To receive all mails sent to release-critical bugs, subscribe to the
<a href="http://lists.debian.org/debian-bugs-rc/">debian-bugs-rc</a>
mailing list.

EOF
}

makepage() {
	if [ ! -d "`dirname $3`" ]; then mkdir -p "`dirname $3`"; fi
	realmakepage "$1" "$2" "$4" "$5" > $3.new
	mv -f $3.new $3
}

time=$(date -u -d '@'$(($(stat -c '%Y' status) / 3600 * 3600)))
oldtime=$(date -u -d '@'$(($(stat -c '%Y' status-old) / 3600 * 3600)))
title="Release-critical bugs status"

makepage "debian" "$title" "$htmldir/debian/all.html" "$time"
makepage "debian/main" "$title" $htmldir/debian/main.html "$time"
makepage "debian/contrib" "$title" $htmldir/debian/contrib.html "$time"
makepage "debian/non-free" "$title" $htmldir/debian/non-free.html "$time"
makepage "debian/source" "$title" $htmldir/debian/source.html "$time"

makepage "" "$title" $htmldir/other/all.html "$time"
makepage "" "$title" "$htmldir/other/stable.html" "$time" "-b"
makepage "" "$title" "$htmldir/other/testing.html" "$time" "-t"
makepage "" "$title" "$htmldir/other/pseudo.html" "$time" "pseudo"

makemainpage > $htmldir/index.html.new
mv -f $htmldir/index.html.new $htmldir/index.html

